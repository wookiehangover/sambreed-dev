---
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import Header from "../../components/Header.astro";
import { getCollection } from "astro:content";
import getAllCategories from "../../utils/get-all-categories";
import WikiCard from "../../components/search/WikiCard.astro";

const wikiEntries = await getCollection("wiki");
const { map } = getAllCategories(wikiEntries);

const query = Astro.url.searchParams.get("q");

let results = null;

if (query) {
  const response = await fetch(`${Astro.url.origin}/api/search?q=${query}&type=wiki`);
  results = await response.json();
}
---

<html lang="en">
  <head>
    <BaseHead title="Wiki Search" description="Wiki Search" />
  </head>
  <body>
    <Header />

    <section>
      <header>
        <h2>Wiki Search</h2>
      </header>
      <div>
        <form>
          <input
            type="search"
            autocapitalize="off"
            autocorrect="off"
            autocomplete="off"
            placeholder="Search"
            name="q"
            value={query ?? ""}
          />
          <button>Go</button>
        </form>

        {
          results && (
            <ul>
              {results.map((entry: any) => (
                <WikiCard entry={entry} map={map} />
              ))}
            </ul>
          )
        }
      </div>
    </section>

    <Footer />
  </body><style>
    body {
      display: flex;
      flex-direction: column;
    }

    section {
      flex-grow: 1;
    }

    form {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    input {
      flex-grow: 1;
      padding: 0.5rem;
      border: 1px solid var(--border-dim);
      border-radius: 4px;
      font-size: 1rem;
      line-height: 1.3;
      background: transparent;
      color: var(--text-color);
      outline: none;
    }

    button {
      background-color: var(--border-dim);
      color: var(--text-color);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-size: 1rem;
      line-height: 1.3;
    }

    ul {
      display: grid;
      list-style: none;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin: 0;
      padding: 0;
    }

    @media (max-width: 512px) {
      ul {
        grid-template-columns: 1fr;
      }
    }
  </style>
</html>
